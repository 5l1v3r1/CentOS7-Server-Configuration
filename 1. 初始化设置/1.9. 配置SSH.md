## 1.9. 配置SSH

### 1.9.1. 配置SSH服务器

#### 1.9.1.1. 密码验证登录

CentOS默认安装OpenSSH，编辑`/etc/ssh/sshd_config`文件，做一些安全设置（根据需要修改）：

禁止root远程登录，将`PermitRootLogin`一行取消注释，并修改为：

`PermitRootLogin no`

禁止空密码，使用密码验证登录：

```
PermitEmptyPasswords no
PasswordAuthentication yes
```

`systemctl restart sshd` # 重启服务以生效

firewalld防火墙设置（SSH默认端口22/TCP）：

```
firewall-cmd --add-service=ssh --permanent
firewall-cmd --reload
```

修改端口：

编辑`/etc/ssh/sshd_config`文件，`Port 22`取消注释，并添加一行想要使用的端口（不要和服务器其他常用端口冲突）如10000，则添加`Port 10000`，将对应的防火墙规则先添加好。运行`systemctl restart sshd`重启SSH后测试是否可以通过添加的端口连接。可以连接后将`Port 22`重新注释并重启SSH。

#### 1.9.1.2. 密钥验证登录

为客户端创建一个私钥，并为服务器创建一个公钥。

为每个用户创建密钥对，因此使用普通用户登录并按如下操作：

`ssh-keygen -t rsa` # 创建密钥对

```
Generating public/private rsa key pair.
Enter file in which to save the key (/home/cent/.ssh/id_rsa):  # 回车
Created directory '/home/cent/.ssh'.
Enter passphrase (empty for no passphrase):  # 设置密码短语（没有密码短语则直接回车）
Enter same passphrase again:  # 确认密码短语
Your identification has been saved in /home/cent/.ssh/id_rsa.
Your public key has been saved in /home/cent/.ssh/id_rsa.pub.
The key fingerprint is:
38:f1:b4:6d:d3:0e:59:c8:fa:1d:1d:48:86:f0:fe:74 cent@dlp.srv.world
The key's randomart image is:
```

`mv ~/.ssh/id_rsa.pub ~/.ssh/authorized_keys`

`chmod 600 ~/.ssh/authorized_keys` # 更改文件权限

将在服务器上创建的密钥传输到客户端，然后可以使用密钥身份验证登录：

`mkdir ~/.ssh`

`chmod 700 ~/.ssh`

`scp cent@10.0.0.30:/home/cent/.ssh/id_rsa ~/.ssh/` # 将密钥[复制](#193-ssh文件传输)到本地ssh目录

```
cent@10.0.0.30's password:
id_rsa
```

`ssh -i ~/.ssh/id_rsa cent@10.0.0.30` # 使用密钥验证登录

```
Enter passphrase for key '/home/cent/.ssh/id_rsa':  # 之前设置的密码短语
Last login: Wed Jul 30 21:37:19 2014 from www.srv.world
```

将`/etc/ssh/sshd_config`文件中的`PasswordAuthentication`设置为`no`，禁止密码验证登录，会更安全。

Windows客户端比较简单，在此不作介绍了。

### 1.9.2. 配置SSH客户端

#### 1.9.2.1. CentOS客户端

`yum -y install openssh-clients`

使用普通用户连接到SSH服务器：

`ssh cent@dlp.srv.world` # `ssh [用户名@域名或IP]`

```
The authenticity of host 'dlp.srv.world (<no hostip for proxy command>)' can't be established.
ECDSA key fingerprint is xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:60:90:d8.
Are you sure you want to continue connecting (yes/no)? yes  # 输入yes确认
Warning: Permanently added 'dlp.srv.world' (ECDSA) to the list of known hosts.
cent@dlp.srv.world's password:  # 用户cent的密码
```

可以使用SSH在远程主机上执行命令，如下所示：

`ssh cent@dlp.srv.world "cat /etc/passwd"` # 在远程主机上执行`cat /etc/passwd`

```
cent@dlp.srv.world's password:
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
...
...
postfix:x:89:89::/var/spool/postfix:/sbin/nologin
sshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin
```

#### 1.9.2.2. Windows客户端

Windows下SSH客户端很多，推荐[Xshell](http://www.netsarang.com/products/xsh_overview.html)，使用方法就不多说了。

### 1.9.3. SSH文件传输

### 1.9.3.1. CentOS客户端

**使用SCP（Secure Copy）**

命令格式：`scp [选项] 源文件 目标`

`scp ./test.txt cent@www.srv.world:~/` # 将本地的`test.txt`复制到远程服务器`www.srv.world`

```
cent@www.srv.world's password:  # 输入远程主机cent用户的密码
100%   10   0.0KB/s   00:00
```

`scp cent@www.srv.world:/home/cent/test.txt ./test.txt` # 
将远程服务器`www.srv.world`上的`/home/cent/test.txt`复制到本地

```
cent@prox.srv.world's password:# 输入远程主机cent用户的密码
test.txt   100%   10   0.0KB/s   00:00
```

**使用SFTP（SSH File Transfer Protocol）**

SFTP服务器默认启用，如果没有启用，编辑`/etc/ssh/sshd_config`文件，添加一行内容：`Subsystem sftp /usr/libexec/openssh/sftp-server`，然后重启SSH服务。

命令格式：`sftp [选项] [用户名@远程主机域名或IP]`

`sftp cent@www.srv.world`

```
cent@www.srv.world's password:  # 输入远程主机cent用户的密码
Connected to prox.srv.world.
sftp>
```

```
sftp> pwd  # 显示远程服务器上的当前目录
Remote working directory: /home/cent
```

```
sftp> !pwd  # 显示本地服务器上的当前目录
/home/redhat
```


```
sftp> ls -l  # 在FTP服务器上显示当前目录中的文件
drwxrwxr-x  2 cent  cent   6 Jul 29 21:33 public_html
-rw-rw-r--  1 cent  cent  10 Jul 28 22:53 test.txt
```

```
sftp> !ls -l  # 在本地服务器上的当前目录中显示文件
total 4
-rw-rw-r-- 1 redhat  redhat  10 Jul 29 21:31 test.txt
```

```
sftp> cd public_html  # 更改目录
sftp> pwd
Remote working directory: /home/cent/public_html
```

```
sftp> put test.txt redhat.txt  # 将文件上传到远程服务器
Uploading test.txt to /home/cent/redhat.txt
test.txt 100% 10 0.0KB/s 00:00
sftp> ls -l
drwxrwxr-x  2 cent  cent   6 Jul 29 21:33 public_html
-rw-rw-r--  1 cent  cent  10 Jul 29 21:39 redhat.txt
-rw-rw-r--  1 cent  cent  10 Jul 28 22:53 test.txt
```

```
sftp> put *.txt  # 将多个文件上传到远程服务器
Uploading test.txt to /home/cent/test.txt
test.txt 100% 10 0.0KB/s 00:00
Uploading test2.txt to /home/cent/test2.txt
test2.txt 100% 0 0.0KB/s 00:00
sftp> ls -l
drwxrwxr-x  2 cent  cent   6 Jul 29 21:33 public_html
-rw-rw-r--  1 cent  cent  10 Jul 29 21:39 redhat.txt
-rw-rw-r--  1 cent  cent  10 Jul 29 21:45 test.txt
-rw-rw-r--  1 cent  cent  10 Jul 29 21:46 test2.txt
```

```
sftp> get test.txt  # 从远程服务器下载文件
Fetching /home/cent/test.txt to test.txt
/home/cent/test.txt 100% 10 0.0KB/s 00:00
```

```
sftp> get *.txt  # 从远程服务器下载多个文件
Fetching /home/cent/redhat.txt to redhat.txt
/home/cent/redhat.txt 100% 10 0.0KB/s 00:00
Fetching /home/cent/test.txt to test.txt
/home/cent/test.txt 100% 10 0.0KB/s 00:00
Fetching /home/cent/test2.txt to test2.txt
/home/cent/test2.txt 100% 10 0.0KB/s 00:00
```

```
sftp> mkdir testdir  # 在远程服务器上创建目录
sftp> ls -l
drwxrwxr-x  2 cent  cent   6 Jul 29 21:33 public_html
-rw-rw-r--  1 cent  cent  10 Jul 29 21:39 redhat.txt
-rw-rw-r--  1 cent  cent  10 Jul 29 21:45 test.txt
-rw-rw-r--  1 cent  cent  10 Jul 29 21:46 test2.txt
drwxrwxr-x  2 cent  cent  6 Jul 29 21:53 testdir
```

```
sftp> rmdir testdir  # 删除远程服务器上的目录
rmdir ok, `testdir' removed
sftp> ls -l
drwxrwxr-x  2 cent  cent   6 Jul 29 21:33 public_html
-rw-rw-r--  1 cent  cent  10 Jul 29 21:39 redhat.txt
-rw-rw-r--  1 cent  cent  10 Jul 29 21:45 test.txt
-rw-rw-r--  1 cent  cent  10 Jul 29 21:46 test2.txt
```

```
sftp> rm test2.txt  # 删除远程服务器上的文件
Removing /home/cent/test2.txt
sftp> ls -l
drwxrwxr-x  2 cent  cent   6 Jul 29 21:33 public_html
-rw-rw-r--  1 cent  cent  10 Jul 29 21:39 redhat.txt
-rw-rw-r--  1 cent  cent  10 Jul 29 21:45 test.txt
```

```
sftp> !cat /etc/passwd  # 使用“!命令”来执行命令
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
...
...
redhat:x:1001:1001::/home/redhat:/bin/bash
```

```
sftp> quit  # 退出
221 Goodbye.
```

#### 1.9.3.2. Windows客户端

推荐[Xftp](http://www.netsarang.com/products/xfp_overview.html)，使用方法也不多说了。

#### 1.9.3.3 仅SFTP + Chroot

应用此设置的某些用户只能使用SFTP访问和访问允许的目录。

例如，将/home设置为Chroot目录：

`groupadd sftp_users` # 为SFTP创建一个组

`usermod -G sftp_users cent` # 仅用于SFTP的用户“cent”

编辑`/etc/ssh/sshd_config`文件：

```
# 注释下面一行，并添加上第二行
#Subsystem sftp /usr/libexec/openssh/sftp-server
Subsystem sftp internal-sftp

# 添加以下内容
Match Group sftp_users
  X11Forwarding no
  AllowTcpForwarding no
  ChrootDirectory /home
  ForceCommand internal-sftp
```

`systemctl restart sshd` # 重启服务以生效

尝试使用用户访问并确保设置：

`ssh cent@10.0.0.30` # 通过SSH客户端访问

```
cent@10.0.0.30's password:  # 输入密码
This service allows sftp connections only.
Connection to 10.0.0.30 closed.  # 拒绝访问
```

`sftp cent@10.0.0.30` # 通过SFTP客户端访问

```
Connecting to 10.0.0.30...
cent@10.0.0.30's password:
sftp> ls -l
drwx------  3 1000  1000  4096 Jul  9 12:06 cent
drwx------  2 1001  1001    59 Jul  8 22:06 hirokun
sftp> pwd
Remote working directory: /
sftp> exit
```


