## 10.2. 代理服务器

### 10.2.1. 安装Squid

安装[Squid](http://www.squid-cache.org/)以配置代理服务器。

`yum -y install squid`

一般的转发代理设置：

编辑`/etc/squid/squid.conf`文件：

```
acl CONNECT method CONNECT
# 添加（定义新的ACL）
acl lan src 10.0.0.0/24

http_access allow localhost
# 添加（允许上面定义的ACL）
http_access allow lan

# 添加以下内容到最后
request_header_access Referer deny all
request_header_access X-Forwarded-For deny all
request_header_access Via deny all
request_header_access Cache-Control deny all

# 不显示IP地址
forwarded_for off
```

```
systemctl start squid
systemctl enable squid
```

firewalld防火墙规则，允许代理服务：

```
firewall-cmd --add-service=squid --permanent
firewall-cmd --reload
```

### 10.2.2. 配置客户端

配置代理客户端以连接到代理服务器。

CentOS客户端如下设置：

编辑`/etc/profile`文件：

```
# 添加以下内容到最后（将代理设置设为环境变量）
MY_PROXY_URL="http://prox.srv.world:3128/"

HTTP_PROXY=$MY_PROXY_URL
HTTPS_PROXY=$MY_PROXY_URL
FTP_PROXY=$MY_PROXY_URL
http_proxy=$MY_PROXY_URL
https_proxy=$MY_PROXY_URL
ftp_proxy=$MY_PROXY_URL

export HTTP_PROXY HTTPS_PROXY FTP_PROXY http_proxy https_proxy ftp_proxy
```

`source /etc/profile`

设置完成。

也可以为每个应用程序设置代理设置，如下所示：

配置yum使用代理，编辑`/etc/yum.conf`文件：

```
# 添加到最后
proxy=http://prox.srv.world:3128/
```

配置wget使用代理，编辑`/etc/wgetrc`文件：

```
# 添加到最后
http_proxy = http://prox.srv.world:3128/
https_proxy = http://prox.srv.world:3128/
ftp_proxy = http://prox.srv.world:3128/
```

Windows客户端在IE选项中设置或具体的程序中设置。

### 10.2.3. 基本认证

设置基本身份验证并限制Squid用户需要身份验证。

`yum -y install httpd-tools` # 安装一个包含htpasswd的软件包

配置Squid以设置基本认证：

编辑`/etc/squid/squid.conf`文件：

```
acl CONNECT method CONNECT
# 为基本验证添加以下内容
auth_param basic program /usr/lib64/squid/basic_ncsa_auth /etc/squid/.htpasswd
auth_param basic children 5
auth_param basic realm Squid Basic Authentication
auth_param basic credentialsttl 5 hours
acl password proxy_auth REQUIRED
http_access allow password
```

`htpasswd -c /etc/squid/.htpasswd cent` # 添加用户：使用-c创建一个新文件（添加-c选项仅用于初始注册）

```
New password:  # 设置密码
Re-type new password:  # 确认密码
Adding password for user cent
```

`systemctl restart squid`

配置CentOS代理客户端使用基本身份验证：

编辑`/etc/profile`文件：

```
# 添加以下内容到最后
# 格式：用户名:密码@代理服务器:端口
MY_PROXY_URL="http://cent:password@prox.srv.world:3128/"

HTTP_PROXY=$MY_PROXY_URL
HTTPS_PROXY=$MY_PROXY_URL
FTP_PROXY=$MY_PROXY_URL
http_proxy=$MY_PROXY_URL
https_proxy=$MY_PROXY_URL
ftp_proxy=$MY_PROXY_URL

export HTTP_PROXY HTTPS_PROXY FTP_PROXY http_proxy https_proxy ftp_proxy
```

`source /etc/profile`

设置完成。

也可以为每个应用程序设置代理设置，如下所示：

配置yum使用代理，编辑`/etc/yum.conf`文件：

```
# 添加到最后
proxy=http://prox.srv.world:3128/
proxy_username=cent
proxy_password=password
```

配置wget使用代理，编辑`/etc/wgetrc`文件：

```
# 添加到最后
http_proxy = http://prox.srv.world:3128/
https_proxy = http://prox.srv.world:3128/
ftp_proxy = http://prox.srv.world:3128/
proxy_user = cent
proxy_passwd = password
```

Windows客户端不需要特别设置，访问Web时，代理服务器弹出需要身份验证，然后输入用户名和密码。

### 10.2.4. 反向代理设置

将Squid配置为反向代理服务器。

编辑`/etc/squid/squid.conf`文件：

```
# 添加（允许所有http访问）
http_access allow all
# And finally deny all other access to this proxy
http_access deny all

# 指定后端Web服务器
http_port 80 accel defaultsite=www.srv.world

# 取消注释
# 数值表示 -> [disk cache size磁盘缓存大小] [number of directories on top level顶层目录数] [number of directories on 2nd level二级目录数]
cache_dir ufs /var/spool/squid 100 16 256

# 添加到最后
cache_peer www.srv.world parent 80 0 no-query originserver

# 内存缓存大小
cache_mem 256 MB

# 定义主机名
visible_hostname prox.srv.world
```

```
systemctl start squid
systemctl enable squid
```

如果需要监听Squid上的HTTP访问，更改LAN中的DNS或路由器的设置，然后尝试从具有Web浏览器的客户端电脑访问Squid反向代理服务器，如下所示：

![proxy-squid-reverse](../Contents/proxy-squid-reverse.png)






