## 10.5. OpenVPN

[OpenVPN](https://openvpn.net/)是一个基于OpenSSL库的应用层VPN实现。

### 10.5.1. 使用证书认证连接

本例基于以下环境：

![openvpn-environment](../Contents/openvpn-environment.png)

使用桥接模式配置OpenVPN，OpenVPN服务器的“br0”和“tap0”由服务自动生成，客户端上“tap0”的IP地址由OpenVPN服务器分配。连接VPN后，客户端可以访问（与服务器）同一本地网络上的任何计算机。

配置之前，必须在网关路由器上配置IP伪装。对于本例，与`x.x.x.x:1194`的连接将转发到`192.168.0.30:1194`。

#### 10.5.1.1. 服务端

安装OpenVPN：

`yum --enablerepo=epel -y install openvpn easy-rsa net-tools bridge-utils`

创建CA证书：

`cd /usr/share/easy-rsa/2.0`

编辑`vars`文件：

```
# 根据自己需要更改
export KEY_COUNTRY="CN"
export KEY_PROVINCE="SC"
export KEY_CITY="CD"
export KEY_ORG="GTS"
export KEY_EMAIL="root@dlp.srv.world"
export KEY_OU="Server_World"
```

`source ./vars`

```
NOTE: If you run ./clean-all, I will be doing a rm -rf on /usr/share/easy-rsa/2.0/keys
```

`./clean-all`

`./build-ca`

```
Generating a 2048 bit RSA private key
..............+++
...+++
writing new private key to 'ca.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [CN]:  # 回车
State or Province Name (full name) [SC]:  # 回车
Locality Name (eg, city) [CD]:  # 回车
Organization Name (eg, company) [GTS]:  # 回车
Organizational Unit Name (eg, section) [Server_World]:  # 回车
Common Name (eg, your name or your server's hostname) [GTS CA]:  # 回车
Name [EasyRSA]:Server-CA  # 设置任意名称
Email Address [root@dlp.srv.world]:  # 回车
```

创建服务器证书：

`cd /usr/share/easy-rsa/2.0`

`./build-key-server server`

```
Generating a 2048 bit RSA private key
.................................................+++
.................+++
writing new private key to 'server.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [CN]:  # 回车
State or Province Name (full name) [SC]:  # 回车
Locality Name (eg, city) [CD]:  # 回车
Organization Name (eg, company) [GTS]:  # 回车
Organizational Unit Name (eg, section) [Server_World]:  # 回车
Common Name (eg, your name or your server's hostname) [server]:  # 回车
Name [EasyRSA]:Server-CRT  # 设置任意名称
Email Address [root@dlp.srv.world]:  # 回车

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
Using configuration from /usr/share/easy-rsa/2.0/openssl-1.0.0.cnf
Check that the request matches the signature
Signature ok
The Subject's Distinguished Name is as follows
countryName           :PRINTABLE:'CN'
stateOrProvinceName   :PRINTABLE:'SC'
localityName          :PRINTABLE:'CD'
organizationName      :PRINTABLE:'GTS'
organizationalUnitName:T61STRING:'Server_World'
commonName            :PRINTABLE:'server'
name                  :PRINTABLE:'Server-CRT'
emailAddress          :IA5STRING:'root@dlp.srv.world'
Certificate is to be certified until Jun 23 05:59:34 2025 GMT (3650 days)
Sign the certificate? [y/n]: y  # 确认设置并输入y继续执行
# proceed with yes
1 out of 1 certificate requests certified, commit? [y/n] y  # 输入y继续执行
Write out database with 1 new entries
Data Base Updated
```

生成Diffie Hellman（DH）参数：

`cd /usr/share/easy-rsa/2.0`

`./build-dh`

```
Generating DH parameters, 2048 bit long safe prime, generator 2
This is going to take a long time
```

创建客户端证书：

`cd /usr/share/easy-rsa/2.0`

`./build-key client01`

```
Generating a 2048 bit RSA private key
............+++
.......................................................+++
writing new private key to 'client01.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [CN]:  # 回车
State or Province Name (full name) [SC]:  # 回车
Locality Name (eg, city) [CD]:  # 回车
Organization Name (eg, company) [GTS]:  # 回车
Organizational Unit Name (eg, section) [Server_World]:  # 回车
Common Name (eg, your name or your server's hostname) [client01]:  # 回车
Name [EasyRSA]:client01  # 设置任意名称
Email Address [root@dlp.srv.world]:  # 回车

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
Using configuration from /usr/share/easy-rsa/2.0/openssl-1.0.0.cnf
Check that the request matches the signature
Signature ok
The Subject's Distinguished Name is as follows
countryName           :PRINTABLE:'CN'
stateOrProvinceName   :PRINTABLE:'SC'
localityName          :PRINTABLE:'CD'
organizationName      :PRINTABLE:'GTS'
organizationalUnitName:T61STRING:'Server_World'
commonName            :PRINTABLE:'client01'
name                  :PRINTABLE:'client01'
emailAddress          :IA5STRING:'root@dlp.srv.world'
Certificate is to be certified until Jun 23 06:01:37 2025 GMT (3650 days)
Sign the certificate? [y/n]: y  # 确认设置并输入y继续执行
# proceed with yes
1 out of 1 certificate requests certified, commit? [y/n] y  # 输入y继续执行
Write out database with 1 new entries
Data Base Updated
```

配置并启动OpenVPN服务器：

`cp -pR /usr/share/easy-rsa/2.0/keys /etc/openvpn/keys`

`cp /usr/share/doc/openvpn-*/sample/sample-config-files/server.conf /etc/openvpn/`

编辑`/etc/openvpn/server.conf`文件：

```
# 根据需要修改（侦听端口）
port 1194

# 取消注释“tcp”并注释掉“udp”
proto tcp
;proto udp

# 更改为tap（使用桥接模式）
dev tap0
;dev tun

# 更改证书路径
ca keys/ca.crt
cert keys/server.crt
key keys/server.key
dh keys/dh2048.pem

# 注释
;server 10.8.0.0 255.255.255.0

# 取消注释并更改：[VPN服务器IP地址] [子网掩码] [客户端的IP范围]
server-bridge 192.168.0.30 255.255.255.0 192.168.0.150 192.168.0.199

# keepalive设置
keepalive 10 120

# 启用压缩
comp-lzo

# 启用persist选项
persist-key
persist-tun

# 取消注释并指定日志
log /var/log/openvpn.log
log-append /var/log/openvpn.log

# 指定日志级别（0 - 9，9表示调试级别）
verb 3
```

`cp /usr/share/doc/openvpn-*/sample/sample-scripts/bridge-start /etc/openvpn/openvpn-startup`

`cp /usr/share/doc/openvpn-*/sample/sample-scripts/bridge-stop /etc/openvpn/openvpn-shutdown`

`chmod 755 /etc/openvpn/openvpn-startup /etc/openvpn/openvpn-shutdown`

编辑`/etc/openvpn/openvpn-startup`文件：

```
# 更改
eth="eth0"  # 根据需要更改
eth_ip="192.168.0.30"  # 网桥接口IP
eth_netmask="255.255.255.0"  # 子网掩码
eth_broadcast="192.168.0.255"  # 广播地址

# 添加以内容到最后（定义网关）
eth_gw="192.168.0.1"
route add default gw $eth_gw
```

`cp /usr/lib/systemd/system/openvpn@.service /usr/lib/systemd/system/openvpn-bridge.service`

编辑`/usr/lib/systemd/system/openvpn-bridge.service`文件：

```
# 在[Service]部分如下更改
[Service]
PrivateTmp=true
Type=forking
PIDFile=/var/run/openvpn/openvpn.pid
ExecStartPre=/bin/echo 1 > /proc/sys/net/ipv4/ip_forward
ExecStartPre=/etc/openvpn/openvpn-startup
ExecStart=/usr/sbin/openvpn --daemon --writepid /var/run/openvpn/openvpn.pid --cd /etc/openvpn/ --config server.conf
ExecStopPost=/etc/openvpn/openvpn-shutdown
ExecStopPost=/bin/echo 0 > /proc/sys/net/ipv4/ip_forward
```

`systemctl start openvpn-bridge`

```
[ 1367.964300] device tap0 entered promiscuous mode
[ 1367.967487] IPv6: ADDRCONF(NETDEV_UP): tap0: link is not ready
[ 1367.971388] br0: port 1(eth0) entered forwarding state
[ 1367.972534] br0: port 1(eth0) entered forwarding state
[ 1368.006320] IPv6: ADDRCONF(NETDEV_CHANGE): tap0: link becomes ready
[ 1368.007546] br0: port 2(tap0) entered forwarding state
[ 1368.008452] br0: port 2(tap0) entered forwarding state
```

`systemctl enable openvpn-bridge`

将`/etc/openvpn/keys`下的文件“ca.crt”，“client01.crt”，“client01.key”传输到客户端计算机以连接到OpenVPN服务器。

#### 10.5.1.2. 客户端

Windows客户端为例。在[这里](https://openvpn.net/index.php/open-source/downloads.html)下载客户端。安装在默认路径。

安装完成后，将`C:\Program Files\OpenVPN\sample-config`下的“client.ovpn”复制到`C:\Program Files\OpenVPN\config`，并重命名为在服务端创建客户端证书时的名称（这里为“client01”）。此外，将在服务器上创建的文件“ca.crt”，“client01.crt”，“client01.key”也复制到`C:\Program Files\OpenVPN\config`，如下所示：



























