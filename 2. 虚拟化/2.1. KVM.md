## 2.1. KVM

是使用KVM（Kernel-based Virtual Machine）加QEMU的虚拟化。这要求计算机CPU具有Intel VT或AMD-V功能。运行`egrep '^flags.*(vmx|svm)' /proc/cpuinfo`验证是否支持（运行后有显示则支持）。

### 2.1.1. 安装KVM

`yum -y install qemu-kvm libvirt virt-install bridge-utils`

确保模块已加载：

`lsmod | grep kvm`

启动并设置开机启动：

```
systemctl start libvirtd
systemctl enable libvirtd
```

为KVM虚拟机配置桥接网络：

这里以“eth0”为例，实际操作中替换为你自己环境的接口名称（IP和网关等也是）。

添加桥接“br0”：

`nmcli c add type bridge autoconnect yes con-name br0 ifname br0`

给br0设置IP、网关和DNS：

```
nmcli c modify br0 ipv4.addresses 10.0.0.30/24 ipv4.method manual
nmcli c modify br0 ipv4.gateway 10.0.0.1
nmcli c modify br0 ipv4.dns 10.0.0.1
```

删除eth0的当前设置（如果是远程操作会断开，最好是本机操作或双网卡）：

`nmcli c delete eth0`

添加eth0接口作为br0的成员：

`nmcli c add type bridge-slave autoconnect yes con-name eth0 ifname eth0 master br0`

设置完成后重启电脑，运行`ip addr`查看。

### 2.1.2. 创建一个虚拟机

以安装CentOS7为例

通过网络以文本模式安装客户机，可以在控制台或Putty等远程连接上使用。此外，虚拟机的映像默认放置在`/var/lib/libvirt/images`作为存储池，但本示例演示创建和使用新的存储池。

```
virt-install \
--name centos7 \
--ram 4096 \
--disk path=/var/kvm/images/centos7.img,size=30 \
--vcpus 2 \
--os-type linux \
--os-variant rhel7 \
--network bridge=br0 \
--graphics none \
--console pty,target_type=serial \
--location 'http://mirrors.163.com/centos/7/os/x86_64/' \
--extra-args 'console=ttyS0,115200n8 serial'
```

上面选项的意思如下（更多的选项可使用`man virt-install`命令查看）。

`--name` 指定虚拟机的名称

`--ram` 指定虚拟机的内存大小

`--disk path=xxx ,size=xxx` “path=”指定虚拟机磁盘的位置，“size=”指定虚拟机的磁盘空间

`--vcpus` 指定虚拟CPU

`--os-type` 指定客户机的类型

`--os-variant` 指定客户机的种类（可以使用命令`osinfo-query os`查看列表）

`--network` 指定虚拟机的网络类型

`--graphics` 指定图像的种类。如果设置为“none”，则意味着没有图像。

`--console` 指定控制台类型

`--location` 指定安装源位置

`--extra-args` 指定在内核中设置的参数

在文本模式下安装，与普通的安装过程相同。安装完成后，首先重新启动，然后登录。

使用快捷键“Ctrl + ]”从客户机转到主机

使用命令`virsh console 虚拟机名称`从主机转到客户机，如：

`virsh console centos7`

因为从网络安装客户机后，它是最小化安装，因此可以将其保存为模板以便以后创建新虚拟机。















