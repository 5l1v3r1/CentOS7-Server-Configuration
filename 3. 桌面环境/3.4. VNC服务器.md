## 3.4. VNC服务器

### 3.4.1. VNC服务器

安装VNC服务器以从远程客户端连接GUI。此示例基于[GNOME桌面环境](../3. 桌面环境/3.1. GNOME桌面.html)。

`yum -y install tigervnc-server` # 安装[TigerVNC](http://tigervnc.org/)服务器

`su - cent` # 切换到要配置VNC的用户

`vncpasswd` # 设置VNC密码

```
Password:  # 输入密码
Verify:  # 确认密码
```

`vncserver :1 -geometry 800x600 -depth 24` # 运行时显示编号'1'，屏幕分辨率'800x600'，颜色深度'24'

打开防火墙端口5901/TCP（对应上面的数字“1”）。

**更多配置**：

拷贝一份配置文件示例：

`cp /lib/systemd/system/vncserver@.service /etc/systemd/system/vncserver@:1.service`

编辑`/etc/systemd/system/vncserver@:1.service`文件，找到对应的内容进行修改：

```
User=<USER>

PIDFile=/home/<USER>/.vnc/%H%i.pid
```

改为

```
User=cent  # cent为使用的用户

PIDFile=/home/cent/.vnc/%H%i.pid

# 如果使用root则修改对应
User=root

PIDFile=/root/.vnc/%H%i.pid
```

重启systemd：

```
systemctl daemon-reload
```

启动并添加开机启动：

```
systemctl start vncserver@:1.service
systemctl enable vncserver@:1.service
```

### 3.4.2. VNC客户端

### 3.4.2.1. Windows客户端

在客户机上安装VNC viewer，如[UltraVNC](http://www.uvnc.com/downloads/ultravnc.html)。

安装完成后，运行“UltraVNC Viewer”，输入`IP地址:显示编号`（10.0.0.30:1）：

![vnc-run](../Contents/vnc-run.png)

输入在服务端设置的密码：

![vnc-password](../Contents/vnc-password.png)

连接成功：

![vnc-connected](../Contents/vnc-connected.png)

### 3.4.2.2. noVNC

[noVNC](http://novnc.com/info.html)是通过Web浏览器连接到VNC服务器的VNC客户端。

`yum --enablerepo=epel -y install novnc python-websockify numpy` # 从EPEL安装

`cd /etc/pki/tls/certs`

`openssl req -x509 -nodes -newkey rsa:2048 -keyout /etc/pki/tls/certs/novnc.pem -out /etc/pki/tls/certs/novnc.pem -days 365`

```
Generating a 2048 bit RSA private key
..........................................+++
..........................................+++
writing new private key to '/etc/pki/tls/certs/novnc.pem'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:CN  # 国家
State or Province Name (full name) [Some-State]:SC # 省
Locality Name (eg, city) []:CD  # 城市
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Server World  # 公司
Organizational Unit Name (eg, section) []:IT Solution  # 部门
Common Name (eg, YOUR name) []:dlp.srv.world  # 服务器域名全称
Email Address []:xxx@srv.world  # 管理员邮箱
```

运行VNC服务器（见[VNC服务器章节](#341-vnc服务器)）。

在运行VNC服务器并在端口“6080”上代理`localhost:5901`的用户启动Websockify：

`websockify -D --web=/usr/share/novnc/ --cert=/etc/pki/tls/certs/novnc.pem 6080 localhost:5901`

```
WebSocket server settings:
  - Listen on :6080
  - Flash security policy server
  - Web server. Web root: /usr/share/novnc
  - SSL/TLS support
  - Backgrounding (daemon)
```

在防火墙打开端口6080/TCP。

在客户端浏览器上访问`http(s)://服务器IP地址或域名:6080/`，使用VNC密码登录：

![novnc-connect](../Contents/novnc-connect.png)

登录后可以在浏览器中操作CentOS：

![novnc-connected](../Contents/novnc-connected.png)

上面的方式每个端口（6080/tcp）只能访问一个vnc服务端，如果有多个服务端需要访问，这样的方法不是很方便，需如下操作。

创建`vnc_tokens`文件，如`/root/vnc_tokens`，内容如下：

```
# 以"token: host:port"的格式输入实际需要连接的vnc服务端
host1: 192.168.0.100:5901
host2: 192.168.0.110:5901
```

运行：

```
websockify -D --web=/usr/share/novnc/ --cert=/etc/pki/tls/certs/novnc.pem --ssl-only --target-config /root/vnc_tokens 6080
```

`--ssl-only`指仅允许通过`https://`方式访问

`--target-config`指定配置文件路径（可以是文件，也可以是包含配置文件的目录）

如果使用单独的证书文件和密钥文件，则`--cert=`指定证书文件，`--key=`指定密钥文件

更多内容可以运行`websockify --help`查看。

运行后在浏览器打开地址：`https://主机名:6080/vnc_auto.html?path=websockify/?token=host1`连接host1（连接host2，则修改为`token=host2`即可）

**Apache配置反向代理示例**：

代理`http://主机名:6080/`：

```
<VirtualHost *:80>
ServerAdmin webmaster@localhost
ServerName vnc.x.com
RewriteEngine On
RewriteCond %{HTTPS} !=On
RewriteRule (.*) https://%{SERVER_NAME}%{REQUEST_URI} [R=301,L]
</VirtualHost>

<VirtualHost *:443>
ServerAdmin webmaster@localhost
ServerName vnc.x.com
ErrorLog logs/vnc-ssl_error_log
TransferLog logs/vnc-ssl_access_log
LogLevel warn
SSLEngine On
SSLProtocol -All +TLSv1 +TLSv1.1 +TLSv1.2
SSLCertificateFile /etc/pki/tls/certs/localhost.crt
SSLCertificateKeyFile /etc/pki/tls/private/localhost.key
SSLProxyEngine on
ProxyRequests Off 

RewriteEngine On
RewriteCond %{HTTP:Upgrade} =websocket
RewriteRule /(.*) ws://localhost:6080/$1 [P,L]
RewriteCond %{HTTP:Upgrade} !=websocket
RewriteRule /(.*) http://localhost:6080/$1 [P,L]

<Proxy *>
Require all granted
</Proxy>
ProxyPass / http://localhost:6080/
ProxyPassReverse / http://localhost:6080/
</VirtualHost>
```

代理`https://主机名:6080/`：

```
<VirtualHost *:80>
ServerAdmin webmaster@localhost
ServerName vnc.x.com
RewriteEngine On
RewriteCond %{HTTPS} !=On
RewriteRule (.*) https://%{SERVER_NAME}%{REQUEST_URI} [R=301,L]
</VirtualHost>

<VirtualHost *:443>
ServerName vnc.ailinzenith.cn
ServerAdmin webmaster@localhost
ErrorLog logs/vnc-ssl_error_log
TransferLog logs/vnc-ssl_access_log
LogLevel warn
SSLEngine On

# 关闭证书检查保护(如果不启用，连接会报错)
SSLProxyVerify none
SSLProxyCheckPeerCN off
SSLProxyCheckPeerName off
SSLProxyCheckPeerExpire off

SSLProtocol -All +TLSv1 +TLSv1.1 +TLSv1.2
SSLCertificateFile /etc/pki/tls/certs/localhost.crt
SSLCertificateKeyFile /etc/pki/tls/private/localhost.key
SSLProxyEngine on
ProxyRequests Off 

RewriteEngine On
RewriteCond %{HTTP:Upgrade} =websocket
RewriteRule /(.*) wss://localhost:6080/$1 [P,L]
RewriteCond %{HTTP:Upgrade} !=websocket
RewriteRule /(.*) https://localhost:6080/$1 [P,L]

<Proxy *>
Require all granted
</Proxy>
ProxyPass / https://localhost:6080/
ProxyPassReverse / https://localhost:6080/
</VirtualHost>
```

配置完成后使用`http://vnc.x.com`或`https://vnc.x.com`访问

### 3.4.2.3. Guacamole

[Guacamole](http://guacamole.apache.org/)是一个基于HTML 5和JavaScript的VNC查看器，服务端基于Java的VNC-to-XML代理开发。要求浏览器支持HTML 5。

安装教程<http://guacamole.apache.org/doc/gug/installing-guacamole.html>

