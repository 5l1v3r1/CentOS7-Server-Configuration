## 4.2. iSCSI

### 4.2.1. 配置iSCSI目标

网络上的存储称为iSCSI目标（iSCSI Target），连接到iSCSI目标的客户端称为iSCSI启动器（iSCSI Initiator）。

本例基于以下环境：

![iscsi-environment](../Contents/iscsi-environment.png)

首先安装管理工具：

`yum -y install targetcli`

配置iSCSI目标，例如，在`/iscsi_disks`目录下创建磁盘映像并将其设置为SCSI设备：

`mkdir /iscsi_disks` # 创建目录

`targetcli` # 进入管理控制台

```
targetcli shell version 2.1.fb34
Copyright 2011-2013 by Datera, Inc and others.
For help on commands, type 'help'.

/> cd backstores/fileio

# 在/iscsi_disks/disk01.img上创建名为“disk01”的10G磁盘映像
/backstores/fileio> create disk01 /iscsi_disks/disk01.img 10G
Created fileio disk01 with size 10737418240

/backstores/fileio> cd /iscsi

# 创建目标
/iscsi> create iqn.2014-07.world.srv:storage.target00
Created target iqn.2014-07.world.srv:storage.target00.
Created TPG 1.
Global pref auto_add_default_portal=true
Created default portal listening on all IPs (0.0.0.0), port 3260.

/iscsi> cd iqn.2014-07.world.srv:storage.target00/tpg1/luns

# 设置LUN
/iscsi/iqn.20...t00/tpg1/luns> create /backstores/fileio/disk01
Created LUN 0.

/iscsi/iqn.20...t00/tpg1/luns> cd ../acls

# 设置ACL（它是允许连接的启动器的IQN）
/iscsi/iqn.20...t00/tpg1/acls> create iqn.2014-07.world.srv:www.srv.world
Created Node ACL for iqn.2014-07.world.srv:www.srv.world
Created mapped LUN 0.

/iscsi/iqn.20...t00/tpg1/acls> cd iqn.2014-07.world.srv:www.srv.world

# 设置用于验证的UserID
/iscsi/iqn.20....srv.world> set auth userid=username
Parameter userid is now 'username'.

/iscsi/iqn.20....srv.world> set auth password=password
Parameter password is now 'password'.

/iscsi/iqn.20....srv.world> exit
Global pref auto_save_on_exit=true
Last 10 configs saved in /etc/target/backup.
Configuration saved to /etc/target/saveconfig.json
```

配置完成后，目标进入监听如下：

`ss -napt | grep 3260`

```
LISTEN     0      256          *:3260                     *:*
```

`systemctl enable target`

firewalld防火墙规则：

```
firewall-cmd --add-service=iscsi-target --permanent
firewall-cmd --reload
```

**使用scsi-target-utils配置iSCSI目标**：

`yum --enablerepo=epel -y install scsi-target-utils` # 从EPEL安装

配置iSCSI目标，例如，在`/iscsi_disks`目录下创建磁盘映像并将其设置为共享磁盘：

`mkdir /iscsi_disks`

`dd if=/dev/zero of=/iscsi_disks/disk01.img count=0 bs=1 seek=10G`

编辑`/etc/tgt/targets.conf`文件：

```
# 添加以下内容到最后
# 如果您设置了一些设备，添加<target>-</target>，并按照相同的方式设置
# 命名规则：[ iqn.yaer-month.domain:any name ]
<target iqn.2015-12.world.srv:target00>
    # 提供的设备作为iSCSI目标
    backing-store /iscsi_disks/disk01.img
    # 允许连接的iSCSI启动器IP地址
    initiator-address 10.0.0.31
    # 验证信息（设置任意“用户名”，“密码”）
    incominguser username password
</target>
```

如果启用了SELinux，更改SELinux Context：

`chcon -R -t tgtd_var_lib_t /iscsi_disks`

`semanage fcontext -a -t tgtd_var_lib_t /iscsi_disks`

firewalld防火墙规则：

```
firewall-cmd --add-service=iscsi-target --permanent
firewall-cmd --reload
```


















