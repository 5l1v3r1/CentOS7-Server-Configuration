## 7.1. FreeIPA

## 7.1.1. 配置IPA服务器

配置IPA服务器以在本地网络中共享用户的帐户。

安装[FreeIPA](http://www.freeipa.org/page/Main_Page)：

`yum -y install ipa-server ipa-server-dns bind bind-dyndb-ldap`

设置FreeIPA服务器：

编辑`/etc/hosts`文件：

```
# 添加本机IP
10.0.0.30   dlp.srv.world dlp
```

`ipa-server-install --setup-dns`

```
The log file for this installation can be found in /var/log/ipaserver-install.log
==============================================================================
This program will set up the IPA Server.

This includes:
  * Configure a stand-alone CA (dogtag) for certificate management
  * Configure the Network Time Daemon (ntpd)
  * Create and configure an instance of Directory Server
  * Create and configure a Kerberos Key Distribution Center (KDC)
  * Configure Apache (httpd)

To accept the default shown in brackets, press the Enter key.

# 设置DNS（现有BIND设置被覆盖）
Existing BIND configuration detected, overwrite? [no]: yes
Enter the fully qualified domain name of the computer
on which you're setting up server software. Using the form
<hostname>.<domainname>
Example: master.example.com.

# 确认主机名并回车
Server host name [dlp.srv.world]:

The domain name has been determined based on the host name.

# 确认域名并回车
Please confirm the domain name [srv.world]:

The kerberos protocol requires a Realm name to be defined.
This is typically the domain name converted to uppercase.

# 确认领域名称并回车
Please provide a realm name [SRV.WORLD]:
Certain directory server operations require an administrative user.
This user is referred to as the Directory Manager and has full access
to the Directory for system management tasks and will be added to the
instance of directory server created for IPA.
The password must be at least 8 characters long.

# 目录管理器的密码
Directory Manager password:
Password (confirm):

The IPA server requires an administrative user, named 'admin'.
This user is a regular system account used for IPA server administration.

# IPA管理员密码
IPA admin password:
Password (confirm):

# 设置DNS转发器，回答yes或no
Do you want to configure DNS forwarders? [yes]:
Enter the IP address of DNS forwarder to use, or press Enter to finish.
# 如果设置DNS转发器，指定DNS转发器的IP
Enter IP address for a DNS forwarder: 10.0.0.10
DNS forwarder 10.0.0.10 added
# 如果DNS转发器正常，则不用输入
Enter IP address for a DNS forwarder:
# 设置反向区域，回答yes或no
Do you want to configure the reverse zone? [yes]:
# 反向区域名称（如果设置了反向区域）
Please specify the reverse zone name [0.0.10.in-addr.arpa.]:

The IPA Master Server will be configured with:
Hostname:      dlp.srv.world
IP address:    10.0.0.30
Domain name:   srv.world
Realm name:    SRV.WORLD

BIND DNS server will be configured to serve IPA domain with:
Forwarders:    10.0.0.10
Reverse zone:  0.0.10.in-addr.arpa.

# 确认设置并输入“yes”继续
Continue to configure the system with these values? [no]: yes

The following operations may take some minutes to complete.
Please wait until the prompt is returned.

Configuring NTP daemon (ntpd)
...
...
...
==============================================================================
Setup complete

Next steps:
        1. You must make sure these network ports are open:
                TCP Ports:
                  * 80, 443: HTTP/HTTPS
                  * 389, 636: LDAP/LDAPS
                  * 88, 464: kerberos
                UDP Ports:
                  * 88, 464: kerberos
                  * 123: ntp

        2. You can now obtain a kerberos ticket using the command: 'kinit admin'
           This ticket will allow you to use the IPA tools (e.g., ipa user-add)
           and the web user interface.

Be sure to back up the CA certificate stored in /root/cacert.p12
This file is required to create replicas. The password for this
file is the Directory Manager password
```

获取Kerberos票证并更改默认shell：

`kinit admin`

```
Password for admin@SRV.WORLD:  # IPA管理员密码
```

`klist` # 确认

```
Ticket cache: KEYRING:persistent:0:0
Default principal: admin@SRV.WORLD

Valid starting       Expires              Service principal
03/21/2015 14:25:53  03/24/2015 14:25:50  krbtgt/SRV.WORLD@SRV.WORLD
```

`ipa config-mod --defaultshell=/bin/bash`

```
Maximum username length: 32
Home directory base: /home
Default shell: /bin/bash
Default users group: ipausers
Default e-mail domain: srv.world
Search time limit: 2
Search size limit: 100
User search fields: uid,givenname,sn,telephonenumber,ou,title
Group search fields: cn,description
Enable migration mode: FALSE
Certificate Subject base: O=SRV.WORLD
Password Expiration Notification (days): 4
Password plugin features: AllowNThash
SELinux user map order: guest_u:s0$xguest_u:s0$user_u:s0$staff_u:s0-s0:c0.c1023$unconfined_u:s0-s0:c0.c1023
Default SELinux user: unconfined_u:s0-s0:c0.c1023
Default PAC types: MS-PAC
```

firewalld防火墙规则：

```
firewall-cmd --add-service={ssh,dns,freeipa-ldap,freeipa-ldaps} --permanent
firewall-cmd --reload
```

## 7.1.2. 添加用户帐户

在FreeIPA服务器上添加用户帐户。

添加用户（在此设置的密码需要在初始登录时更改）：

`ipa user-add cent --first=CentOS --last=Linux --password`

```
Password:  # 设置密码
Enter Password again to verify:
-----------------
Added user "cent"
-----------------
  User login: cent
  First name: CentOS
  Last name: Linux
  Full name: CentOS Linux
  Display name: CentOS Linux
  Initials: CL
  Home directory: /home/cent
  GECOS field: CentOS Linux
  Login shell: /bin/bash
  Kerberos principal: cent@SRV.WORLD
  Email address: cent@srv.world
  UID: 1219600001
  GID: 1219600001
  Password: True
  Kerberos keys available: True
```

`ipa user-find cent` # 确认

```
--------------
1 user matched
--------------
  User login: cent
  First name: CentOS
  Last name: Linux
  Home directory: /home/cent
  Login shell: /bin/bash
  Email address: cent@srv.world
  UID: 1219600001
  GID: 1219600001
  Account disabled: False
  Password: True
  Kerberos keys available: True
----------------------------
Number of entries returned 1
----------------------------
```

将现有本地用户添加到IPA目录（本例的用户名设置相同的密码，但是在初始登录时需要更改）：

编辑`ipauser.sh`文件：

```
# 提取UID为1000-9999的本地用户，下面为示例
#!/bin/bash

for line in `grep "x:[1-9][0-9][0-9][0-9]:" /etc/passwd`
do
   USER=`echo $line | cut -d: -f1`
   FIRST=`echo $line | cut -d: -f5 | awk {'print $1'}`
   LAST=`echo $line | cut -d: -f5 | awk {'print $2'}`

   [ ! "$FIRST" ] && FIRST=$USER
   [ ! "$LAST" ] && LAST=$USER

   echo $USER | ipa user-add $USER --first=$FIRST --last=$LAST --password
done
```

`sh ipauser.sh`

```
-------------------
Added user "redhat"
-------------------
  User login: redhat
  First name: redhat
  Last name: redhat
  Full name: redhat redhat
  Display name: redhat redhat
  Initials: rr
  Home directory: /home/redhat
  GECOS field: redhat redhat
  Login shell: /bin/bash
  Kerberos principal: redhat@SRV.WORLD
  Email address: redhat@srv.world
  UID: 1219600003
  GID: 1219600003
  Password: True
  Kerberos keys available: True
-------------------
Added user "ubuntu"
-------------------
  User login: ubuntu
  First name: ubuntu
  Last name: ubuntu
  Full name: ubuntu ubuntu
  Display name: ubuntu ubuntu
  Initials: uu
  Home directory: /home/ubuntu
  GECOS field: ubuntu ubuntu
  Login shell: /bin/bash
  Kerberos principal: ubuntu@SRV.WORLD
  Email address: ubuntu@srv.world
  UID: 1219600004
  GID: 1219600004
  Password: True
  Kerberos keys available: True
```

## 7.1.3. 配置IPA客户端

配置FreeIPA客户端连接到FreeIPA服务器。

首先在FreeIPA服务器上为FreeIPA客户端添加DNS条目。

`ipa dnsrecord-add srv.world client01 --a-rec 10.0.0.51` # 格式为：ipa dnsrecord-add [domain name] [record name] [record type] [record]

```
Record name: client01
A record: 10.0.0.51
```



































