## 8.1. FTP

### 8.1.1. Vsftpd

#### 8.1.1.1. 安装Vsftpd

安装[Vsftpd](https://security.appspot.com/vsftpd.html)以配置FTP服务器：

`yum -y install vsftpd`

编辑`/etc/vsftpd/vsftpd.conf`文件（具体配置及意义可以自行网上查找资料）：

```
# 禁止匿名登录
anonymous_enable=NO

# 取消注释（允许ascii模式）
ascii_upload_enable=YES
ascii_download_enable=YES

# 取消注释（启用chroot）
chroot_local_user=YES
chroot_list_enable=YES

# 取消注释（指定chroot列表）
chroot_list_file=/etc/vsftpd/chroot_list

# 取消注释
ls_recurse_enable=YES

# 更改（如果使用IPv4）
listen=YES

# 更改（如果不需要IPv6则关闭）
listen_ipv6=NO

# 添加以下内容到最后
# 指定根目录（如果不指定，用户的主目录成为FTP主目录）
local_root=public_html

# 使用本地时间
use_localtime=YES

# 关闭seccomp过滤器（如果无法登录，添加此行）
seccomp_sandbox=NO
```

编辑`/etc/vsftpd/chroot_list`文件：

```
# 添加允许移动到其主目录的用户
cent
```

```
systemctl start vsftpd
systemctl enable vsftpd
```

firewalld防火墙规则：

```
firewall-cmd --add-service=ftp --permanent
firewall-cmd --reload
```

如果启用了SELinux，更改布尔设置：

`setsebool -P ftpd_full_access on`

#### 8.1.1.2. Vsftpd + TLS

为Vsftpd启用SSL/TLS以使用安全的FTP连接。

创建自签名证书：

`cd /etc/pki/tls/certs`

`openssl req -x509 -nodes -newkey rsa:2048 -keyout vsftpd.pem -out vsftpd.pem -days 365`

```
Generating a 2048 bit RSA private key
......++++++
.......++++++
writing new private key to '/etc/pki/tls/certs/vsftpd.pem'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:CN  # 国家
State or Province Name (full name) [Some-State]:SC  # 省
Locality Name (eg, city) []:CD  # 城市
Organization Name (eg, company) [Internet Widgits Pty Ltd]:GTS  # 公司
Organizational Unit Name (eg, section) []:Server World  # 部门
Common Name (eg, YOUR name) []:www.srv.world  # 服务器域名全称
Email Address []:xxx@srv.world  # 管理员邮箱
```

`chmod 400 vsftpd.pem`

配置Vsftpd：

编辑`/etc/vsftpd/vsftpd.conf`文件：

```
# 添加到最后
# 固定PASV端口
pasv_enable=YES
pasv_min_port=21000
pasv_max_port=21010

# 启用TLS
rsa_cert_file=/etc/pki/tls/certs/vsftpd.pem
ssl_enable=YES
ssl_ciphers=HIGH
ssl_tlsv1=YES
ssl_sslv2=NO
ssl_sslv3=NO
force_local_data_ssl=YES
force_local_logins_ssl=YES
```

`systemctl restart vsftpd`

firewalld防火墙规则，允许固定的PASV端口：

```
firewall-cmd --add-port=21000-21010/tcp --permanent
firewall-cmd --reload
```

### 8.1.2. ProFTPD

#### 8.1.2.1. 安装ProFTPD

安装[ProFTPD](http://www.proftpd.org/)以配置FTP服务器。

`yum --enablerepo=epel -y install proftpd` # 从EPEL安装

编辑`/etc/proftpd.conf`文件：

```
# 更改为自己的主机名
ServerName       "www.srv.world"

# 更改为自己的电子邮件地址
ServerAdmin       root@srv.world

# 添加以下内容，获取访问日志和验证日志
ExtendedLog     /var/log/proftpd/access.log WRITE,READ default
ExtendedLog     /var/log/proftpd/auth.log AUTH auth
```

编辑`/etc/ftpusers`文件：

```
# 添加禁止访问FTP的用户
test
```

```
systemctl start proftpd
systemctl enable proftpd
```

firewalld防火墙规则：

```
firewall-cmd --add-service=ftp --permanent
firewall-cmd --reload
```

如果启用了SELinux，更改布尔设置：

`setsebool -P ftpd_full_access on`

#### 8.1.2.2. ProFTPD + TLS

为ProFTPD配置使用SSL/TLS。

创建自签名证书：

`cd /etc/pki/tls/certs`

`openssl req -x509 -nodes -newkey rsa:2048 -keyout proftpd.pem -out proftpd.pem -days 365`

```
Generating a 2048 bit RSA private key
......++++++
.......++++++
writing new private key to '/etc/pki/tls/certs/proftpd.pem'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:CN  # 国家
State or Province Name (full name) [Some-State]:SC  # 省
Locality Name (eg, city) []:CD  # 城市
Organization Name (eg, company) [Internet Widgits Pty Ltd]:GTS  # 公司
Organizational Unit Name (eg, section) []:Server World  # 部门
Common Name (eg, YOUR name) []:www.srv.world  # 服务器域名全称
Email Address []:xxx@srv.world  # 管理员邮箱
```

`chmod 600 proftpd.pem`

配置ProFTPD：

编辑`/etc/proftpd.conf`文件：

```
# 添加到最后
# 固定PASV端口
PassivePorts              21000 21010

# 启用TLS
TLSEngine                 on
TLSRequired               on
TLSProtocol               TLSv1.2
TLSLog                    /var/log/proftpd/tls.log
TLSRSACertificateFile     /etc/pki/tls/certs/proftpd.pem
TLSRSACertificateKeyFile  /etc/pki/tls/certs/proftpd.pem
```

`systemctl restart proftpd`

firewalld防火墙规则，允许固定的PASV端口：

```
firewall-cmd --add-port=21000-21010/tcp --permanent
firewall-cmd --reload
```

### 8.1.3. Pure-FTPd

#### 8.1.3.1. 安装Pure-FTPd

安装[Pure-FTPd](https://www.pureftpd.org/project/pure-ftpd)以配置FTP服务器。

`yum --enablerepo=epel -y install pure-ftpd` # 从EPEL安装

编辑`/etc/pure-ftpd/pure-ftpd.conf`文件：

```
# # 禁止匿名登录
NoAnonymous       yes

# 取消注释（如果仅使用IPv4）
IPV4Only       yes

# 取消注释（如果仅使用IPv6）
IPV6Only       yes
```

```
systemctl start pure-ftpd
systemctl enable pure-ftpd
```

firewalld防火墙规则：

```
firewall-cmd --add-service=ftp --permanent
firewall-cmd --reload
```

如果启用了SELinux，更改布尔设置：

`setsebool -P ftpd_full_access on`

#### 8.1.3.2. Pure-FTPd + TLS

为Pure-FTPd配置使用SSL/TLS。

创建自签名证书：

`cd /etc/pki/tls/certs`

`openssl req -x509 -nodes -newkey rsa:2048 -keyout pure-ftpd.pem -out pure-ftpd.pem -days 365`

```
Generating a 2048 bit RSA private key
......++++++
.......++++++
writing new private key to '/etc/pki/tls/certs/pure-ftpd.pem'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:CN  # 国家
State or Province Name (full name) [Some-State]:SC  # 省
Locality Name (eg, city) []:CD  # 城市
Organization Name (eg, company) [Internet Widgits Pty Ltd]:GTS  # 公司
Organizational Unit Name (eg, section) []:Server World  # 部门
Common Name (eg, YOUR name) []:www.srv.world  # 服务器域名全称
Email Address []:xxx@srv.world  # 管理员邮箱
```

`chmod 600 pure-ftpd.pem`

配置Pure-FTPd：

编辑`/etc/pure-ftpd/pure-ftpd.conf`文件：

```
# 取消注释并固定PASV端口
PassivePorts              21000 21010

# 取消注释
TLS       1
```

`systemctl restart pure-ftpd`

firewalld防火墙规则，允许固定的PASV端口：

```
firewall-cmd --add-port=21000-21010/tcp --permanent
firewall-cmd --reload
```

#### 8.1.3.3. Pure-FTPd + Clamav

配置Pure-FTPd + Clamav通过FTP连接及时扫描病毒。

先[安装Clamav](https://www.server-world.info/en/note?os=CentOS_7&p=clamav)。

配置Pure-FTPd：

编辑`/etc/pure-ftpd/pure-ftpd.conf`文件：

```
# 取消注释
CallUploadScript   yes
```

编辑`/usr/local/bin/pure-ftpd_clamscan.sh`文件：

```
#!/bin/bash

/usr/bin/clamscan --remove --quiet --no-summary "$1"
```

`chmod 755 /usr/local/bin/pure-ftpd_clamscan.sh`

编辑`/etc/systemd/system/clamav.pure-ftpd.service`文件：

```
[Unit]
Description=Clamav Scanning Service for Pure-FTPd
Before=pure-ftpd.service

[Service]
Type=simple
RemainAfterExit=yes
ExecStart=/usr/sbin/pure-uploadscript -B -r /usr/local/bin/pure-ftpd_clamscan.sh

[Install]
WantedBy=multi-user.target
```

```
systemctl --system daemon-reload
systemctl restart clamav.pure-ftpd pure-ftpd
systemctl enable clamav.pure-ftpd
```

通过FTP上传[测试病毒](http://www.eicar.org/85-0-Download.html)到服务器，确保设置正常工作。病毒将上传，但会被立即删除。

### 8.1.4. FTP客户端

### 8.1.4.1. CentOS客户端





















### 8.1.4.2. Windows客户端














### 8.1.4.3. 客户端使用TLS








