## 附1.1. 系统安全

### 附1.1.1. Clam AntiVirus

[Clam AntiVirus（ClamAV）](https://www.clamav.net/)是免费而且开放源代码的防毒软件，软件与病毒码的的更新皆由社群免费发布。目前ClamAV主要是使用在由Linux、FreeBSD等Unix-like系统架设的邮件服务器上，提供电子邮件的病毒扫描服务。

`yum --enablerepo=epel -y install clamav clamav-update` # 从EPEL安装

`sed -i -e "s/^Example/#Example/" /etc/freshclam.conf`

`freshclam` # 更新病毒库

```
ClamAV update process started at Fri Aug 29 22:03:30 2014
main.cld is up to date (version: 55, sigs: 2424225, f-level: 60, builder: neo)
daily.cvd is up to date (version: 19314, sigs: 1094505, f-level: 63, builder: neo)
bytecode.cvd is up to date (version: 242, sigs: 46, f-level: 63, builder: dgoddard)
```

尝试扫描：

`clamscan --infected --remove --recursive /home`

```
----------- SCAN SUMMARY -----------
Known viruses: 3575245
Engine version: 0.98.4
Scanned directories: 2
Scanned files: 3
Infected files: 0
Data scanned: 0.00 MB
Data read: 0.00 MB (ratio 0.00:1)
Time: 10.369 sec (0 m 10 s)
```

`curl -O http://www.eicar.org/download/eicar.com` # 下载试用病毒

`clamscan --infected --remove --recursive .`

```
./eicar.com: Eicar-Test-Signature FOUND
./eicar.com: Removed.  # 检测到病毒

----------- SCAN SUMMARY -----------
Known viruses: 3575245
Engine version: 0.98.4
Scanned directories: 3
Scanned files: 10
Infected files: 1
Data scanned: 0.00 MB
Data read: 256.57 MB (ratio 0.00:1)
Time: 10.307 sec (0 m 10 s)
```

### 附1.1.2. RKHunter

安装Rootkit检测工具[RKHunter](http://rkhunter.cvs.sourceforge.net/viewvc/rkhunter/rkhunter/files/README)。

`yum --enablerepo=epel -y install rkhunter` # 从EPEL安装

配置和使用RKHunter（为了定期检查，检查脚本安装在`cron.daily`目录下，每天由Cron执行）：

编辑`/etc/sysconfig/rkhunter`文件：

```
# 报告的收件人地址
MAILTO=root@localhost
# 如果指定“yes”，扫描更详细
DIAG_SCAN=no
```

`rkhunter --update` # 更新数据库

`rkhunter --propupd` # 更新系统文件属性

执行检查（`--sk`表示跳过按回车键，如果指定`--rwo`只显示警告）：

`rkhunter --check --sk`

```
[ Rootkit Hunter version 1.4.2 ]

Checking system commands...

  Performing 'strings' command checks
    Checking 'strings' command                               [ OK ]

  Performing 'shared libraries' checks
    Checking for preloading variables                        [ None found ]
    Checking for preloaded libraries                         [ None found ]
    Checking LD_LIBRARY_PATH variable                        [ Not found ]

  Performing file properties checks
    Checking for prerequisites                               [ OK ]
    /usr/sbin/adduser                                        [ OK ]
    /usr/sbin/chkconfig                                      [ OK ]
    /usr/sbin/chroot                                         [ OK ]
    /usr/sbin/depmod                                         [ OK ]
    /usr/sbin/fsck                                           [ OK ]

.....
.....

System checks summary
=====================

File properties checks...
    Files checked: 121
    Suspect files: 0

Rootkit checks...
    Rootkits checked : 365
    Possible rootkits: 0

Applications checks...
    All checks skipped

The system checks took: 1 minute and 35 seconds

All results have been written to the log file: /var/log/rkhunter/rkhunter.log

No warnings were found while checking the system.
```

### 附1.1.3. Lynis

[Lynis](https://cisofy.com/lynis/)扫描系统的配置，并创建概述系统信息与安全问题所使用的专业审计。

`yum --enablerepo=epel -y install lynis` 从EPEL安装

使用Lynis：

`lynis audit system` # 初始扫描运行如下

```
.....
.....
================================================================================

  Lynis security scan details:

  Hardening index : 65 [#############       ]
  Tests performed : 200
  Plugins enabled : 0

  Components:
  - Firewall               [V]
  - Malware scanner        [X]

  Lynis Modules:
  - Compliance Status      [?]
  - Security Audit         [V]
  - Vulnerability Scan     [V]

  Files:
  - Test and debug information      : /var/log/lynis.log
  - Report data                     : /var/log/lynis-report.dat

================================================================================

  Lynis 2.3.2

  Auditing, system hardening, and compliance for UNIX-based systems
  (Linux, macOS, BSD, and others)

  2007-2016, CISOfy - https://cisofy.com/lynis/
  Enterprise support available (compliance, plugins, interface and tools)

================================================================================

  [TIP]: Enhance Lynis audits by adding your settings to custom.prf (see /etc/lynis/default.prf for all settings)
```

扫描结果的报告保存在`/var/log/lynis-report.dat`中。使用单词“warning”或“suggestion”搜索文件，然后如下显示推荐的设置：

`grep -E "^warning|^suggestion" /var/log/lynis-report.dat`

```
suggestion[]=BOOT-5122|Set a password on GRUB bootloader to prevent altering boot configuration (e.g. boot 
suggestion[]=AUTH-9286|Configure minimum password age in /etc/login.defs|-|-|
suggestion[]=AUTH-9286|Configure maximum password age in /etc/login.defs|-|-|
suggestion[]=AUTH-9328|Default umask in /etc/profile or /etc/profile.d/custom.sh could be more strict (e.g. 
suggestion[]=FILE-6310|To decrease the impact of a full /home file system, place /home on a separated partit
suggestion[]=FILE-6310|To decrease the impact of a full /tmp file system, place /tmp on a separated partitio
suggestion[]=FILE-6310|To decrease the impact of a full /var file system, place /var on a separated partitio
suggestion[]=STRG-1840|Disable drivers like USB storage when not used, to prevent unauthorized storage or da
suggestion[]=STRG-1846|Disable drivers like firewire storage when not used, to prevent unauthorized storage 
suggestion[]=NAME-4404|Add the IP name and FQDN to /etc/hosts for proper name resolving|-|-|
suggestion[]=PKGS-7384|Install package 'yum-utils' for better consistency checking of the package database|-
suggestion[]=NETW-3032|Consider running ARP monitoring software (arpwatch)|-|-|
warning[]=MAIL-8818|Found mail_name in SMTP banner, and/or mail_name contains 'Postfix'|-|-|
suggestion[]=MAIL-8818|You are advised to hide the mail_name (option: smtpd_banner) from your postfix config 
suggestion[]=FIRE-4513|Check iptables rules to see which rules are currently not used|-|-|
suggestion[]=SSH-7408|Consider hardening SSH configuration|AllowTcpForwarding (YES --> NO)|-|
suggestion[]=SSH-7408|Consider hardening SSH configuration|ClientAliveCountMax (3 --> 2)|-|
suggestion[]=SSH-7408|Consider hardening SSH configuration|Compression (DELAYED --> NO)|-|
suggestion[]=SSH-7408|Consider hardening SSH configuration|LogLevel (INFO --> VERBOSE)|-|
suggestion[]=SSH-7408|Consider hardening SSH configuration|MaxAuthTries (6 --> 1)|-|
suggestion[]=SSH-7408|Consider hardening SSH configuration|MaxSessions (10 --> 2)|-|
suggestion[]=SSH-7408|Consider hardening SSH configuration|PermitRootLogin (YES --> NO)|-|
suggestion[]=SSH-7408|Consider hardening SSH configuration|Port (22 --> )|-|
suggestion[]=SSH-7408|Consider hardening SSH configuration|TCPKeepAlive (YES --> NO)|-|
suggestion[]=SSH-7408|Consider hardening SSH configuration|UseDNS (YES --> NO)|-|
suggestion[]=SSH-7408|Consider hardening SSH configuration|X11Forwarding (YES --> NO)|-|
suggestion[]=SSH-7408|Consider hardening SSH configuration|AllowAgentForwarding (YES --> NO)|-|
suggestion[]=BANN-7126|Add a legal banner to /etc/issue, to warn unauthorized users|-|-|
suggestion[]=BANN-7130|Add legal banner to /etc/issue.net, to warn unauthorized users|-|-|
suggestion[]=ACCT-9622|Enable process accounting|-|-|
suggestion[]=ACCT-9626|Enable sysstat to collect accounting (no results)|-|-|
suggestion[]=ACCT-9630|Audit daemon is enabled with an empty ruleset. Disable the daemon or define rules|-|-
suggestion[]=TIME-3160|Some time servers missing in step-tickers file|-|-|
suggestion[]=FINT-4350|Install a file integrity tool to monitor changes to critical and sensitive files|-|-|
suggestion[]=TOOL-5002|Determine if automation tools are present for system management|-|-|
suggestion[]=KRNL-6000|One or more sysctl values differ from the scan profile and could be tweaked|-|-|
suggestion[]=HRDN-7222|Harden compilers like restricting access to root user only|-|-|
suggestion[]=HRDN-7230|Harden the system by installing at least one malware scanner, to perform periodic fil
```
