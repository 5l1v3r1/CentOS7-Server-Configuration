## 附1.8. 配置管理工具

### 附1.8.1. Salt

[Salt](https://saltstack.com/community/)是一个强大的远程执行管理器，用于快速和高效的服务器管理。

#### 附1.8.1.1. 安装Salt

可以在独立的服务器上使用Salt，本例演示配置为服务器和客户端环境。管理服务器称为Salt Master，客户端服务器称为Salt Minion。

在**Salt Master**主机上安装“salt-master”：

`yum --enablerepo=epel -y install salt-master` # 从EPEL安装

```
systemctl start salt-master
systemctl enable salt-master
```

Salt Master防火墙规则：

```
firewall-cmd --add-port={4505/tcp,4506/tcp} --permanent
firewall-cmd --reload
```

在**Salt Minion**主机上安装“salt-minionr”：

`yum --enablerepo=epel -y install salt-minion` # 从EPEL安装

编辑`/etc/salt/minion`文件:

```
# 取消注释并指定Salt Master服务器
master: dlp.srv.world
```

```
systemctl start salt-minion
systemctl enable salt-minion
```

Salt Minion初始运行时，向Salt Master发送公钥认证。如果Salt Master接受密钥，Salt Master和Salt Minion可以互相连接。

**Salt Master**上运行：

`salt-key -L` # 显示密钥列表

```
Accepted Keys:
Denied Keys:
Unaccepted Keys:
node01.srv.world
Rejected Keys:
```

`salt-key -A` # 使用`A`选项允许所有密钥

```
The following keys are going to be accepted:
Unaccepted Keys:
node01.srv.world
Proceed? [n/Y] y
Key for minion node01.srv.world accepted.
```

`salt-key -L`

```
Accepted Keys:
node01.srv.world
Denied Keys:
Unaccepted Keys:
Rejected Keys:
```

`salt "*" test.ping` # 验证工作

```
node01.srv.world:
    True
```

#### 附1.8.1.2. 基本用法

从Salt Master到Salt Minion远程执行命令的基本用法：

`salt [option] [target] [function] [arguments]`

有关所有嵌入式功能的说明，[参阅官方网站](https://docs.saltstack.com/en/latest/ref/modules/all/index.html)。

也可以使用命令查看功能（有多行输出，使用`less`或`more`的命令来读取）：

`salt '*' sys.doc`

```
'acl.delfacl:'

    Remove specific FACL from the specified file(s)

    CLI Examples:

        salt '*' acl.delfacl user myuser /tmp/house/kitchen
        salt '*' acl.delfacl default:group mygroup /tmp/house/kitchen

.....
.....
```

可以用各种方式指定目标：

`salt '*' test.ping` # 指定所有Minion，`test.ping`表示确认Minion是活动的

```
node02.srv.world:
    True
node01.srv.world:
    True
```

`salt 'node01.srv.world' disk.usage` # 指定Minion：“node01.srv.world”，`disk.usage`表示确认当前磁盘使用率

```
node01.srv.world:
    ----------
    /:
        ----------
        1K-blocks:
            27740944
        available:
            26176776
        capacity:
            6%
        filesystem:
            /dev/mapper/centos-root
        used:
            1564168
.....
.....
```

`salt -L 'node01.srv.world,node02.srv.world' status.loadavg` # 使用列表指定某些Minion（以逗号分隔），`status.loadavg`表示确认平均负载

```
node02.srv.world:
    ----------
    1-min:
        0.0
    15-min:
        0.05
    5-min:
        0.01
node01.srv.world:
.....
.....
```

`salt -E 'node[0-9][0-9].srv.world' selinux.getenforce` # 用表达式指定Minion，示例表示`node00-99.srv.world`，`selinux.getenforce`表示确认SELinux运行模式

```
node02.srv.world:
    Enforcing
node01.srv.world:
    Enforcing
```

`salt -G 'os:CentOS' grains.item kernelrelease` # 使用Grains数据指定操作系统为CentOS的Minion，`grains.item kernelrelease`表示确认内核版本来自“grains.item”数据，“Grains”是Salt中用来保存Minion系统数据或其他内容的词

```
node01.srv.world:
    ----------
    kernelrelease:
        3.10.0-327.36.1.el7.x86_64
node02.srv.world:
    ----------
    kernelrelease:
        3.10.0-327.36.1.el7.x86_64
```

`salt -C 'G@os:CentOS and E@node0[1-5].srv.world' cmd.run 'uptime'` # 用`C`选项指定多个条件，示例表示指定操作系统为CentOS且主机名为`node01-node05`的Minion，`cmd.run`表示执行命令

```
node02.srv.world:
     09:46:43 up 18 min,  0 users,  load average: 0.00, 0.01, 0.03
node01.srv.world:
     09:46:43 up 18 min,  0 users,  load average: 0.07, 0.05, 0.03
```

还可以使用组指定目标：

编辑`/etc/salt/master`文件：

```
# 取消注释
default_include: master.d/*.conf
```

`mkdir /etc/salt/master.d`

编辑`/etc/salt/master.d/nodegroups.conf`文件：

```
# group01：用“L@”指定列表（逗号分隔）specify List with "L@" (comma separated)
# group02：用表达式指定node03-node05
# group03：指定操作系统为CentOS
nodegroups:
  group01: 'L@node01.srv.world,node02.srv.world'
  group02: 'E@node0[3-5].srv.world'
  group03: 'G@os:CentOS'
```

```
systemctl restart salt-master
```

`salt -N 'group01' firewalld.list_services` # 对“group01”组运行，`firewalld.list_services`表示确认firewalld允许的服务

```
node01.srv.world:
    - dhcpv6-client
    - ssh
node02.srv.world:
    - dhcpv6-client
    - ssh
```

#### 附1.8.1.3. 使用Salt State文件

Salt State文件是用YAML文件编写的配置文件。

首先定义存放Salt State文件的根目录。默认位置是`/srv/salt`（本例演示使用默认位置配置）：

编辑`/etc/salt/master`文件：

```
# 取消注释并定义根目录
file_roots:
  base:
    - /srv/salt
```

`mkdir /srv/salt`

将State文件放在根目录下，可以使用`salt`命令将配置应用于Minion（例如，将“wget”软件包安装到Minion）：

编辑`/srv/salt/default.sls`文件（扩展名为“sls”，文件可为任意名称）：

```
install_wget:
  pkg.installed:
    - name: wget
```

`salt "node01.srv.world" state.sls default` # 适用于“node01”

```
node01.srv.world:
----------
          ID: install_wget
    Function: pkg.installed
        Name: wget
      Result: True
     Comment: The following packages were installed/updated: wget

.....
.....

Summary
------------
Succeeded: 1 (changed=1)
Failed:    0
------------
Total states run:     1
```

`salt "node01.srv.world" cmd.run 'rpm -q wget'` # 验证

```
node01.srv.world:
    wget-1.14-10.el7_0.1.x86_64
```

将称为“Top文件”的“top.sls”在定义的根目录下：

编辑`/srv/salt/top.sls`文件：

```
base:
  # 定义目标Minion
  '*':
    # 定义State文件的名称
    - default
```

编辑`/srv/salt/default.sls`文件，创建在Top文件中定义的State文件：

```
# 例如，安装并启动httpd和MariaDB并安装PHP
webserver:
  pkg.installed:
    - pkgs:
      - httpd
      - php
      - php-mbstring
      - php-pear
      - mariadb-server

/var/www/html/index.php:
  file:
    - managed
    - source: salt://httpd/index.php
    - require:
      - pkg: webserver

# 初始设置脚本
/tmp/setup.sql:
  file:
    - managed
    - source: salt://httpd/setup.sql

enable_httpd:
  service.running:
    - name: httpd
    - enable: True
    - require:
      - pkg: webserver

enable_mariadb:
  service.running:
    - name: mariadb
    - enable: True
    - require:
      - pkg: webserver

setup_mariadb:
  cmd.run:
    - name: '/bin/mysql -u root < /tmp/setup.sql'
    - require:
      - service: enable_mariadb

# 如果Firewalld运行，需配置服务
{% set fw_status = salt['service.status']('firewalld') %}
{% if fw_status %}
setup_fw:
  cmd.run:
    - names:
      - '/bin/firewall-cmd --add-service={http,https,mysql}'
      - '/bin/firewall-cmd --add-service={http,https,mysql} --permanent'
{% endif %}
```

编辑`/srv/salt/httpd/index.php`文件，创建index.php模板：

```
<?php
   print "Salt State Test Page";
?>
```

编辑`/srv/salt/httpd/setup.sql`文件，创建MariaDB初始设置脚本：

```
set password for root@localhost=password('password');
set password for root@'127.0.0.1'=password('password'); 
delete from mysql.user where user='';
delete from mysql.user where password='';
drop database test;
```

`salt "*" state.apply` # 运行“state.apply”来应用设置

```
node01.srv.world:
    ----------
    cmd_|-setup_fw_|-/bin/firewall-cmd --add-service={http,https,mysql} --permanent_|-run:
        ----------
        __run_num__:
            7
        changes:

.....
.....

 name:
            mariadb
        result:
            True
        start_time:
            19:56:52.911517
```

验证

`salt "node01.srv.world" cmd.run 'systemctl status httpd'`

```
node01.srv.world:
    * httpd.service - The Apache HTTP Server
       Loaded: loaded (/usr/lib/systemd/system/httpd.service; enabled; vendor preset: disabled)
       Active: active (running) since Mon 2016-10-17 10:56:52 JST; 2min 16s ago
.....
.....
```

`salt "node02.srv.world" cmd.run 'systemctl status httpd'`

`salt "node01.srv.world" cmd.run 'systemctl status httpd'`

```
node01.srv.world:
    * mariadb.service - MariaDB database server
       Loaded: loaded (/usr/lib/systemd/system/mariadb.service; enabled; vendor preset: disabled)
       Active: active (running) since Mon 2016-10-17 10:56:57 JST; 2min 24s ago
.....
.....
```

`salt "node02.srv.world" cmd.run 'systemctl status httpd'`

`salt "node01.srv.world" cmd.run 'mysql -u root -ppassword -e "show databases;"'`

```
node01.srv.world:
    Database
    information_schema
    mysql
    performance_schema
```

`salt "node02.srv.world" cmd.run 'mysql -u root -ppassword -e "show databases;"'`

`curl http://node01.srv.world/index.php`

```
Salt State Test Page
```

`curl http://node02.srv.world/index.php`

#### 附1.8.1.4. 使用Salt-cp

可以使用`salt`命令将文件复制到Minion，但是使用`salt-cp`命令来处理Minion更简单：

`salt-cp '*' test.txt /root/test.txt` # 将当前目录下的`test.txt`复制到所有Minion中的`/root/`中

```
{'node01.srv.world': {'/root/test.txt': True},
'node02.srv.world': {'/root/test.txt': True}}
```

`salt-cp 'node01.srv.world' setup.sql /tmp/setup.sql` # 指定`node01.srv.world`为目标Minion并复制

```
{'node01.srv.world': {'/root/test.txt': True},
'node02.srv.world': {'/root/test.txt': True}}
```

`salt-cp -E 'node[0-9][1-2].srv.world' setup.sql /tmp/setup.sql` # 用表达式指定目标Minion

```
{'node01.srv.world': {'/tmp/setup.sql': True},
'node02.srv.world': {'/tmp/setup.sql': True}}
.....
.....
```

`salt-cp -G 'os:CentOS' config.sh /tmp/config.sh` # 使用Grains数据指定Minion

```
{'node01.srv.world': {'/tmp/config.sh': True},
'node02.srv.world': {'/tmp/config.sh': True}}
.....
.....
```

### 附1.8.2. Puppet

[Puppet](https://puppet.com/)是一个配置管理工具。

#### 附1.8.2.1. 安装Puppet

可以在独立的服务器上使用Puppet，本例演示配置为Puppet服务器和Puppet客户端环境。

必须先设置DNS或hosts来解析名称或IP地址，以及NTP设置。

在**Puppet服务器**主机上安装`puppet-server`：

`yum -y install https://yum.puppetlabs.com/puppetlabs-release-el-7.noarch.rpm`

`sed -i -e "s/enabled=1/enabled=0/g" /etc/yum.repos.d/puppetlabs.repo`

`yum --enablerepo=puppetlabs-products,puppetlabs-deps -y install puppet-server`

编辑`/etc/puppet/puppet.conf`文件：

```
[main]
# 在[main]部分中添加以下内容：Puppet服务器的DNS名称
    dns_alt_names = dlp.srv.world,dlp
```

`puppet master --verbose --no-daemonize`

```
Info: Creating a new SSL key for ca
Info: Creating a new SSL certificate request for ca
Info: Certificate Request fingerprint (SHA256): 
Notice: Signed certificate request for ca
Info: Creating a new certificate revocation list
Info: Creating a new SSL key for dlp.srv.world
Info: csr_attributes file loading from /etc/puppet/csr_attributes.yaml
Info: Creating a new SSL certificate request for dlp.srv.world
Info: Certificate Request fingerprint (SHA256): 
Notice: dlp.srv.world has a waiting certificate request
Notice: Signed certificate request for dlp.srv.world
Notice: Removing file Puppet::SSL::CertificateRequest dlp.srv.world at 
    '/var/lib/puppet/ssl/ca/requests/dlp.srv.world.pem'
Notice: Removing file Puppet::SSL::CertificateRequest dlp.srv.world at 
    '/var/lib/puppet/ssl/certificate_requests/dlp.srv.world.pem'
Notice: Starting Puppet master version 3.8.1
# 按Ctrl + C退出
```

```
systemctl start puppetmaster
systemctl enable puppetmaster
```

在**Puppet客户端**主机安装`puppet`：

`yum -y install https://yum.puppetlabs.com/puppetlabs-release-el-7.noarch.rpm`

`sed -i -e "s/enabled=1/enabled=0/g" /etc/yum.repos.d/puppetlabs.repo`

`yum --enablerepo=puppetlabs-products,puppetlabs-deps -y install puppet`

编辑`/etc/puppet/puppet.conf`文件：

```
[agent]
# 在[agent]部分中添加以下内容：Puppet服务器的主机名或IP地址
    server = dlp.srv.world
```

`puppet agent --test --ca_server=dlp.srv.world`

```
Info: Creating a new SSL key for node01.srv.world
Info: Caching certificate for ca
Info: csr_attributes file loading from /etc/puppet/csr_attributes.yaml
Info: Creating a new SSL certificate request for node01.srv.world
Info: Certificate Request fingerprint (SHA256): 
Info: Caching certificate for ca
Exiting; no certificate found and waitforcert is disabled
```

```
systemctl start puppet
systemctl enable puppet
```

在**Puppet服务器**上启用Puppet客户端的证书：

`puppet cert list` # 显示证书请求

```
"node01.srv.world" (SHA256) xx:xx:xx:xx:xx:xx:xx
```

`puppet cert --allow-dns-alt-names sign node01.srv.world` # 签名

```
Notice: Signed certificate request for node01.srv.world
Notice: Removing file Puppet::SSL::CertificateRequest node01.srv.world at 
    '/var/lib/puppet/ssl/ca/requests/node01.srv.world.pem'
```

创建测试manifest以确认Puppet服务器/客户端正常工作。Puppet客户端默认情况下，每隔30分钟可以使用Puppet服务器上的manifest，所以等一会儿来确认它，或者如果想立即确认，重新启动Puppet客户端守护进程（puppetd）：

编辑`/etc/puppet/manifests/site.pp`文件：

```
# 例如，如下所示创建一个“testgroup”
group { 'testgroup':
    ensure => present,
    gid    => 2000,
}
```

`systemctl restart puppet` # 如果想立即确认重启puppetd

`grep testgroup /etc/group`

```
testgroup:x:2000:
```

可以如下所示手动将manifest应用到本地环境：

`puppet apply /etc/puppet/manifests/site.pp`

```
Notice: Compiled catalog for dlp.srv.world in environment production in 0.13 seconds
Notice: /Stage[main]/Main/Group[testgroup]/ensure: created
Notice: Finished catalog run in 0.34 seconds
```

#### 附1.8.2.2. 文件资源

这是文件资源（file resource）的示例。

它如下管理配置以保存文件（如果文件不在Puppet客户端，则会创建该文件，如果存在，它将保留指定的属性）：

编辑`/etc/puppet/manifests/site.pp`文件：

```
file { '/home/testfile.txt':
    ensure  => file,
    owner   => 'root',
    group   => 'root',
    mode    => 644,
    content => 'This is the puppet test file.',
}
```

编辑`/etc/puppet/manifests/site.pp`文件，使用变量指定内容：

```
$contents = 'This is the test Puppet manifest.
Sample contents
Test contents
'

file { '/home/testfile.txt':
    ensure  => file,
    owner   => 'root',
    group   => 'root',
    mode    => 644,
    content => "$contents",
}
```

将Puppet服务器上的源文件指定为模板：

编辑`/etc/puppet/fileserver.conf`文件：

```
# add to the end: specify the directory which includes template files
# extra_files -> 任意名称
# path        -> 目录路径
# allow       -> 允许访问的客户端（下例表示允许所有），如果要指定客户端，格式为：“allow 192.168.0.0/24”或“*.srv.world”
[extra_files]
    path /etc/puppet/files
    allow *
```

编辑`/etc/puppet/manifests/site.pp`文件：

```
file { '/home/testfile.txt':
    ensure => file,
    owner  => 'root',
    group  => 'root',
    mode   => 644,
    source => 'puppet://dlp.srv.world/extra_files/test.txt',
}
```

`mkdir /etc/puppet/files`

`echo "Puppet test file" > /etc/puppet/files/test.txt`














#### 附1.8.2.3. 软件包资源







#### 附1.8.2.4. 服务资源







#### 附1.8.2.5. 组资源





#### 附1.8.2.6. 用户资源








#### 附1.8.2.7. 执行资源







#### 附1.8.2.8. 节点资源






#### 附1.8.2.9. 类资源





#### 附1.8.2.10. facter变量





### 附1.8.3. Ansible

[Ansible](https://www.ansible.com/)提供一种最简单的方式用于发布、管理和编排计算机系统的工具。













